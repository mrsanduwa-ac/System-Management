<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Out Fashion - Login</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes moveLights{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}body{background-color:#020412;color:#e2e8f0;font-family:'Inter',sans-serif;position:relative;overflow:hidden}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;z-index:-1;background:radial-gradient(circle at 15% 25%,hsla(210,70%,80%,.25),transparent 35%),radial-gradient(circle at 85% 35%,hsla(280,60%,80%,.25),transparent 40%),radial-gradient(circle at 50% 85%,hsla(190,60%,70%,.2),transparent 45%);background-size:250% 250%;animation:moveLights 40s ease-in-out infinite}.overflow-y-auto::-webkit-scrollbar{width:8px}.overflow-y-auto::-webkit-scrollbar-track{background:#2d3748}.overflow-y-auto::-webkit-scrollbar-thumb{background:#4a5568;border-radius:10px}.card{background-color:rgba(26,32,44,.7);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);transition:transform .3s ease,box-shadow .3s ease}.card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.2)}.status-message{transition:all .4s ease-in-out;opacity:0;transform:translateY(-15px);max-height:0;margin-top:0}.status-message.show{opacity:1;transform:translateY(0);max-height:100px;padding:.5rem;margin-top:.75rem}.auto-save-status{opacity:0;transition:opacity .5s ease;color:#48bb78}.auto-save-status.show{opacity:1}.btn-primary,.btn-secondary,.btn-danger,.btn-info,.btn-success,.btn-warning{transition:background-color .2s,transform .1s ease-out}.btn-primary:active,.btn-secondary:active,.btn-danger:active,.btn-info:active,.btn-success:active,.btn-warning:active{transform:scale(.97)}.text-primary{color:#e2e8f0}.text-secondary{color:#a0aec0}.bg-card-section{background-color:rgba(45,55,72,.5)}.border-theme{border-color:rgba(255,255,255,.1)}.btn-primary{background-color:#4299e1;color:#fff}.btn-primary:hover{background-color:#2b6cb0}.btn-secondary{background-color:#4a5568;color:#e2e8f0;border:1px solid #718096}.btn-secondary:hover{background-color:#2d3748}.btn-danger{background-color:#e53e3e;color:#fff}.btn-danger:hover{background-color:#c53030}.btn-info{background-color:#5a67d8;color:#fff}.btn-info:hover{background-color:#4c51bf}.btn-success{background-color:#38a169;color:#fff}.btn-success:hover{background-color:#2f855a}.btn-warning{background-color:#f6ad55;color:#fff}.btn-warning:hover{background-color:#dd6b20}.bg-green-status{background-color:#2f855a;border:1px solid #38a169;color:#c6f6d5}.bg-red-status{background-color:#c53030;border:1px solid #e53e3e;color:#fed7d7}input,select,textarea{background-color:#1a202c;border-color:#4a5568;color:#e2e8f0}input::placeholder,textarea::placeholder{color:#718096}input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.8);cursor:pointer}@media print{body,body::before{background:#fff!important}body>*:not(#print-area){display:none!important}#print-area{display:block!important;position:absolute;left:0;top:0;width:100%;padding:5mm;box-sizing:border-box;font-family:'Arial',sans-serif;color:#000}.no-print{display:none!important}.print-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #333;padding-bottom:5px;margin-bottom:10px}.print-title-group{display:flex;align-items:center;gap:15px}.print-header .company-logo{height:40px}.print-header .company-name-print{font-family:'Impact',Haettenschweiler,'Arial Narrow Bold',sans-serif;font-size:18pt;letter-spacing:1px}.print-header .print-date{font-size:10pt;font-weight:bold}#printBarcodeList{column-count:5;column-gap:15px;font-size:9pt}.print-column{break-inside:avoid;padding-right:10px}.print-column div{margin-bottom:4px;white-space:nowrap}.print-footer{display:none!important}}@keyframes slideInFromLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 lg:p-8">

    <!-- Login Screen -->
    <div id="login-screen" class="w-full max-w-sm">
        <div class="card p-8 rounded-2xl shadow-2xl text-center">
            <img src="logo.png" alt="Company Logo" class="mx-auto h-20 mb-6">
            <h1 class="text-2xl font-extrabold mb-6">System Login</h1>
            <div class="space-y-4">
                <div>
                    <label for="passcodeInput" class="block mb-2 text-sm font-medium text-secondary">Passcode</label>
                    <input type="password" id="passcodeInput" class="w-full p-3 border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 shadow-sm" placeholder="••••••••" inputmode="numeric">
                </div>
                <button id="loginButton" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-primary">
                    <span id="loginBtnText">Login</span>
                    <div id="loginBtnSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
                </button>
                <p id="loginError" class="text-red-400 text-center text-sm h-4"></p>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="app-container" class="card p-6 lg:p-8 rounded-2xl shadow-2xl w-full max-w-7xl no-print hidden">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <img src="logo.png" alt="Company Logo" class="h-12">
                <h1 class="text-2xl lg:text-3xl font-extrabold">
                    <span id="appTitle" class="bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-purple-400"></span>
                </h1>
            </div>
            <div id="live-clock" class="text-xl lg:text-2xl font-bold text-slate-300 order-3 lg:order-2 w-full lg:w-auto text-center"></div>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-8 mt-4">
            <!-- Left Column -->
            <div class="w-full lg:w-3/5 flex flex-col gap-y-6">
                <p id="scanOrderDescription" class="text-center text-secondary -mt-2"></p>
                <div class="p-4 bg-blue-900/30 rounded-lg border border-blue-700/50 text-center shadow-md">
                    <p class="text-xl font-semibold text-blue-200">
                        <span id="uniqueOrderCountLabel"></span>:
                        <span id="uniqueOrderCount" class="text-purple-400 text-2xl font-bold">0</span>
                    </p>
                </div>
                <div>
                     <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="orderScanInput" class="flex-grow p-3 border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 shadow-sm" />
                        <button id="addOrderBarcodeBtn" class="px-6 py-3 rounded-lg font-semibold shadow-md btn-primary"></button>
                    </div>
                    <div id="statusMessage" class="status-message rounded-lg text-center font-semibold p-2"></div>
                </div>
                <div>
                    <!-- UPDATED: Dynamic header for the scanned list -->
                    <h2 id="scannedListHeader" class="text-2xl font-bold text-primary mb-4 border-b border-theme pb-2"></h2>
                    <div id="orderListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-60 lg:max-h-96 overflow-y-auto shadow-inner">
                        <ul id="scannedOrderBarcodesList" class="space-y-2">
                            <p id="noOrderBarcodesMessage" class="text-secondary text-center py-4"></p>
                        </ul>
                    </div>
                </div>
                 <button id="returnToTodayBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-secondary"></button>
            </div>

            <!-- Right Column -->
            <div class="w-full lg:w-2/5 flex flex-col gap-y-8">
                <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                     <h2 id="exportTitle" class="text-2xl font-bold text-primary mb-4 border-b border-theme pb-2"></h2>
                     <button id="saveToSheetBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-warning">
                        <span id="saveBtnText">Save to Google Sheet</span>
                        <div id="saveBtnSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
                     </button>
                     <p id="sheetStatus" class="text-center text-sm h-4 mt-2"></p>
                     <hr class="my-4 border-gray-600">
                     <button id="printScannedOrderBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-info"></button>
                     <button id="downloadCsvBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-success"></button>
                </div>
                <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="loadPreviousOrdersTitle" class="text-2xl font-bold text-primary border-b border-theme pb-2"></h2>
                        <span id="autoSaveStatus" class="auto-save-status font-semibold">✓ Saved</span>
                    </div>

                    <div id="liveSessionDisplay" class="mb-2 p-3 bg-blue-900/40 rounded-lg text-center border border-blue-700/60 hidden">
                        <p class="text-sm text-blue-300">Live Session:</p>
                        <p id="liveSessionName" class="font-bold text-lg text-white"></p>
                    </div>
                    
                    <button id="manualSaveBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn-success text-sm">
                        <span id="manualSaveBtnText">Save Current Session</span>
                        <div id="manualSaveBtnSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>
                    </button>
                    
                    <div class="mb-4">
                         <label id="searchByDateLabel" for="searchByDate" class="block mb-2 text-sm font-medium text-secondary"></label>
                         <div class="flex gap-2">
                            <input type="date" id="searchByDate" class="w-full p-2 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                            <button id="resetDateFilterBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn-secondary text-xs"></button>
                         </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="savedSessionsSelect" class="flex-grow p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500"><option value=""></option></select>
                        <button id="loadSelectedSessionBtn" class="px-6 py-3 rounded-lg font-semibold shadow-md btn-primary"></button>
                    </div>
                    <button id="deleteSelectedSessionBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn-danger"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT AREA -->
    <div id="print-area" class="hidden">
        <div class="print-header">
            <div class="print-title-group">
                <img src="logo.png" alt="Company Logo" class="company-logo">
                <h1 class="company-name-print">World Out Fashion</h1>
            </div>
            <p class="print-date" id="printDate"></p>
        </div>
        <div id="printBarcodeList"></div>
    </div>

    <script>
        // =========================================================================
        // === වැදගත්: මෙතනට ඔබගේ Google Apps Script URL එක ඇතුළත් කරන්න ===
        // =========================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuYsSzGAmbFUClFQEWYbPSYyDKeh3CJn8dn5yPZ4AhFxZtBseTCYurxirFRAzJ25KO/exec"; 
        // =========================================================================

        // State for live data (today)
        let scannedBarcodes = [];
        let currentSessionId = null;

        // State for what is currently being displayed on screen
        let currentlyViewingBarcodes = [];
        let currentlyViewingSessionId = null;

        let allSessions = [];

        const el = {
            loginScreen: document.getElementById('login-screen'), loginButton: document.getElementById('loginButton'), loginBtnText: document.getElementById('loginBtnText'), loginBtnSpinner: document.getElementById('loginBtnSpinner'), passcodeInput: document.getElementById('passcodeInput'), loginError: document.getElementById('loginError'), appContainer: document.getElementById('app-container'), appTitle: document.getElementById("appTitle"), scanOrderDescription: document.getElementById("scanOrderDescription"), uniqueOrderCountLabel: document.getElementById("uniqueOrderCountLabel"), uniqueOrderCount: document.getElementById("uniqueOrderCount"), orderScanInput: document.getElementById("orderScanInput"), addOrderBarcodeBtn: document.getElementById("addOrderBarcodeBtn"), statusMessage: document.getElementById("statusMessage"), scannedListHeader: document.getElementById("scannedListHeader"), scannedOrderBarcodesList: document.getElementById("scannedOrderBarcodesList"), noOrderBarcodesMessage: document.getElementById("noOrderBarcodesMessage"), orderListContainer: document.getElementById("orderListContainer"), returnToTodayBtn: document.getElementById("returnToTodayBtn"), exportTitle: document.getElementById("exportTitle"), printScannedOrderBtn: document.getElementById("printScannedOrderBtn"), downloadCsvBtn: document.getElementById("downloadCsvBtn"), loadPreviousOrdersTitle: document.getElementById("loadPreviousOrdersTitle"), autoSaveStatus: document.getElementById("autoSaveStatus"), searchByDateLabel: document.getElementById("searchByDateLabel"), searchByDate: document.getElementById("searchByDate"), resetDateFilterBtn: document.getElementById("resetDateFilterBtn"), savedSessionsSelect: document.getElementById("savedSessionsSelect"), loadSelectedSessionBtn: document.getElementById("loadSelectedSessionBtn"), deleteSelectedSessionBtn: document.getElementById("deleteSelectedSessionBtn"), liveClock: document.getElementById("live-clock"), saveToSheetBtn: document.getElementById('saveToSheetBtn'), saveBtnText: document.getElementById('saveBtnText'), saveBtnSpinner: document.getElementById('saveBtnSpinner'), sheetStatus: document.getElementById('sheetStatus'), liveSessionDisplay: document.getElementById('liveSessionDisplay'), liveSessionName: document.getElementById('liveSessionName'), manualSaveBtn: document.getElementById('manualSaveBtn'), manualSaveBtnText: document.getElementById('manualSaveBtnText'), manualSaveBtnSpinner: document.getElementById('manualSaveBtnSpinner'),
        };

        // --- CORE & HELPER FUNCTIONS ---
        function setInitialTexts() { el.appTitle.textContent = "Order Management System"; el.scanOrderDescription.textContent = "Scan order items for today's session."; el.uniqueOrderCountLabel.textContent = "Total Scanned"; el.returnToTodayBtn.textContent = "Return to Today's Session"; el.exportTitle.textContent = "Export & Save"; el.printScannedOrderBtn.textContent = "Print Viewed List (A4)"; el.downloadCsvBtn.textContent = "Download Viewed List (CSV)"; el.loadPreviousOrdersTitle.textContent = "View Previous Day's Sessions"; el.searchByDateLabel.textContent = "Filter by Date"; el.resetDateFilterBtn.textContent = "Reset"; el.loadSelectedSessionBtn.textContent = "View"; el.deleteSelectedSessionBtn.textContent = "Delete"; el.orderScanInput.placeholder = "Barcode number..."; el.savedSessionsSelect.innerHTML = `<option value="">Loading...</option>`; }
        function updateClock() { el.liveClock.textContent = (new Date).toLocaleString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: !0 }); }
        function getTimestamp(t) { const e = t ? new Date(parseInt(t, 10)) : new Date; return e.toLocaleString("en-US", { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit", hour12: !0 }); }
        function showStatusMessage(t, e) { el.statusMessage.textContent = t; el.statusMessage.className = "status-message rounded-lg text-center font-semibold p-2"; el.statusMessage.classList.add("success" === e ? "bg-green-status" : "bg-red-status", "show"); setTimeout(() => el.statusMessage.classList.remove("show"), 2500); }
        function getTodaySessionId() { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); return `SESSION-${yyyy}-${mm}-${dd}`; }
        
        // --- API COMMUNICATION ---
        async function apiCall(action, payload = {}) { try { const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action, ...payload }) }); if (!response.ok) throw new Error(`Network response error: ${response.statusText}`); const data = await response.json(); if (data.status !== 'success') throw new Error(data.message || 'Unknown script error.'); return data; } catch (error) { console.error(`API Call Failed for action "${action}":`, error); throw error; } }
        
        // --- UI & STATE MANAGEMENT ---
        function updateUiFromState() {
            el.uniqueOrderCount.textContent = currentlyViewingBarcodes.length;
            el.scannedOrderBarcodesList.innerHTML = "";
            const hasBarcodes = currentlyViewingBarcodes.length > 0;
            const isViewingToday = currentlyViewingSessionId === currentSessionId;
            
            el.scannedListHeader.textContent = isViewingToday ? "Scanned Barcodes (Today)" : `Viewing Session: ${currentlyViewingSessionId.replace('SESSION-','')}`;
            el.noOrderBarcodesMessage.textContent = isViewingToday ? "No barcodes scanned yet for today." : "No barcodes were scanned on this day.";
            el.noOrderBarcodesMessage.style.display = hasBarcodes ? 'none' : 'block';

            if (hasBarcodes) {
                currentlyViewingBarcodes.forEach((barcode, index) => {
                    const listItem = document.createElement("li");
                    listItem.style.animation = `slideInFromLeft 0.5s ease-out forwards`;
                    const scanNumber = currentlyViewingBarcodes.length - index;
                    
                    if(isViewingToday) {
                        listItem.className = "flex items-center justify-between p-2 rounded-md shadow-sm border text-lg font-medium bg-gray-700/50 border-gray-600/50 text-gray-200";
                        const leftDiv = document.createElement('div');
                        leftDiv.className = 'flex items-center';
                        const numberSpan = document.createElement('span');
                        numberSpan.className = "font-bold text-blue-300 w-10 text-left";
                        numberSpan.textContent = `#${scanNumber}`;
                        const barcodeSpan = document.createElement('span');
                        barcodeSpan.textContent = barcode;
                        leftDiv.appendChild(numberSpan);
                        leftDiv.appendChild(barcodeSpan);
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = "Delete";
                        deleteBtn.className = "btn-danger px-3 py-1 text-xs rounded-md font-semibold";
                        deleteBtn.onclick = () => handleDeleteSingleBarcode(scanNumber - 1);
                        listItem.appendChild(leftDiv);
                        listItem.appendChild(deleteBtn);
                    } else {
                        listItem.className = "flex items-center p-2 text-gray-400"; // Dim color for old data
                        listItem.textContent = `#${scanNumber}. ${barcode}`;
                    }
                    el.scannedOrderBarcodesList.appendChild(listItem);
                });
                el.orderListContainer.scrollTop = 0;
            }
            el.liveSessionName.textContent = `Session for ${currentSessionId.replace('SESSION-', '')}`;
            el.liveSessionDisplay.classList.remove('hidden');
        }
        
        // --- APPLICATION LOGIC ---
        function handleLogin() {
            const passcode = el.passcodeInput.value;
            if (!passcode) { el.loginError.textContent = 'Please enter a passcode.'; return; }
            el.loginButton.disabled = true;
            el.loginBtnText.classList.add('hidden');
            el.loginBtnSpinner.classList.remove('hidden');
            el.loginError.textContent = '';
            apiCall("validateLogin", { passcode: passcode })
                .then(() => {
                    el.loginScreen.classList.add('hidden');
                    el.appContainer.classList.remove('hidden');
                    document.title = "World Out Fashion - OMS";
                    initializeApp();
                })
                .catch(error => {
                    console.error("Login Error:", error);
                    el.loginError.textContent = error.message.includes('Invalid Passcode') ? 'Incorrect passcode.' : 'Login failed.';
                    el.passcodeInput.value = '';
                    el.passcodeInput.focus();
                })
                .finally(() => {
                    el.loginButton.disabled = false;
                    el.loginBtnText.classList.remove('hidden');
                    el.loginBtnSpinner.classList.add('hidden');
                });
        }
        
        async function initializeApp() {
            setInitialTexts();
            updateClock();
            setInterval(updateClock, 1000);
            
            currentSessionId = getTodaySessionId();
            currentlyViewingSessionId = currentSessionId;

            el.orderScanInput.addEventListener("keypress", (e) => { if (e.key === 'Enter') handleOrderScanAddBarcode(); });
            el.addOrderBarcodeBtn.addEventListener("click", handleOrderScanAddBarcode);
            el.returnToTodayBtn.addEventListener("click", returnToTodayView);
            el.manualSaveBtn.addEventListener("click", handleManualSave);
            el.loadSelectedSessionBtn.addEventListener("click", loadSelectedSession);
            el.deleteSelectedSessionBtn.addEventListener("click", deleteSelectedSession);
            el.searchByDate.addEventListener("input", filterSessionsByDate);
            el.resetDateFilterBtn.addEventListener("click", () => { el.searchByDate.value = ""; filterSessionsByDate(); });
            el.saveToSheetBtn.addEventListener("click", saveDataToGoogleSheet);
            el.printScannedOrderBtn.addEventListener("click", printScannedOrder);
            el.downloadCsvBtn.addEventListener("click", downloadCsv);
            
            await reloadTodaysData();

            try {
                const data = await apiCall("getAllSessions");
                allSessions = data.sessions;
                filterSessionsByDate();
            } catch (error) {
                Swal.fire("Error", "Could not load previous day's sessions.", "error");
            }
        }

        async function reloadTodaysData() {
             try {
                const data = await apiCall("getSessionData", { sessionId: currentSessionId });
                scannedBarcodes = data.session.data.barcodes || [];
            } catch (error) {
                if (error.message.includes('Session not found')) {
                    scannedBarcodes = [];
                } else {
                    Swal.fire("Error", "Could not load today's session data.", "error");
                }
            }
            returnToTodayView(); // This function now sets both view and live data
        }
        
        function handleOrderScanAddBarcode() {
            if (currentlyViewingSessionId !== currentSessionId) {
                Swal.fire('Action Not Allowed', 'You are currently viewing a past session. Please return to today\'s session to scan new items.', 'warning');
                return;
            }
            const barcode = el.orderScanInput.value.trim();
            if (barcode === "") return;
            if (scannedBarcodes.includes(barcode)) {
                showStatusMessage(`Already Scanned: ${barcode}`, "error");
            } else {
                scannedBarcodes.unshift(barcode);
                showStatusMessage(`Success: ${barcode}`, "success");
                const successAudio = document.getElementById('successSound');
                if (successAudio) {
                    successAudio.pause();
                    successAudio.currentTime = 0;
                    successAudio.play().catch(error => console.error("Audio playback failed:", error));
                }
                updateUiFromState();
                autoSaveSession();
            }
            el.orderScanInput.value = "";
            el.orderScanInput.focus();
        }
        
        function handleDeleteSingleBarcode(reverseIndex) {
            const actualIndex = scannedBarcodes.length - 1 - reverseIndex;
            Swal.fire({
                title: 'Are you sure?', text: `Do you want to permanently delete this barcode?`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!', cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    scannedBarcodes.splice(actualIndex, 1);
                    updateUiFromState();
                    autoSaveSession();
                }
            });
        }

        function returnToTodayView() {
            currentlyViewingSessionId = currentSessionId;
            currentlyViewingBarcodes = scannedBarcodes;
            updateUiFromState();
        }
        
        async function loadSelectedSession() {
            const sessionId = el.savedSessionsSelect.value;
            if (!sessionId) { return Swal.fire({ title: "Please select a previous day's session to view.", icon: 'warning' }); }
            
            el.loadSelectedSessionBtn.disabled = true;
            el.loadSelectedSessionBtn.textContent = "Loading...";
            try {
                const data = await apiCall("getSessionData", { sessionId: sessionId });
                currentlyViewingSessionId = sessionId;
                currentlyViewingBarcodes = data.session.data.barcodes || [];
                updateUiFromState();
            } catch (error) {
                Swal.fire("Error", "Could not load the selected session.", "error");
                returnToTodayView(); // Revert to today's view on error
            } finally {
                el.loadSelectedSessionBtn.disabled = false;
                el.loadSelectedSessionBtn.textContent = "View";
            }
        }
        
        async function handleManualSave() {
            el.manualSaveBtn.disabled = true;
            el.manualSaveBtnText.classList.add('hidden');
            el.manualSaveBtnSpinner.classList.remove('hidden');
            try {
                await autoSaveSession(true); // Pass true to show success alert
            } catch (error) {
                 Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Save failed!', showConfirmButton: false, timer: 2000 });
            } finally {
                el.manualSaveBtn.disabled = false;
                el.manualSaveBtnText.classList.remove('hidden');
                el.manualSaveBtnSpinner.classList.add('hidden');
            }
        }
        
        async function autoSaveSession(showSuccess = false) {
            try {
                await apiCall("saveSession", { sessionId: currentSessionId, barcodes: scannedBarcodes });
                if (showSuccess) {
                     Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Session saved!', showConfirmButton: false, timer: 2000 });
                } else {
                    el.autoSaveStatus.classList.add("show");
                    setTimeout(() => { el.autoSaveStatus.classList.remove("show") }, 2000);
                }
            } catch (error) {
                el.autoSaveStatus.textContent = '✗ Save Failed';
                el.autoSaveStatus.style.color = '#e53e3e';
                el.autoSaveStatus.classList.add("show");
                setTimeout(() => { el.autoSaveStatus.classList.remove("show"); el.autoSaveStatus.textContent = '✓ Saved'; el.autoSaveStatus.style.color = '#48bb78'; }, 3000);
                throw error;
            }
        }
        
        function printScannedOrder(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No barcodes to print.",icon:"warning"});document.getElementById("printDate").textContent=getTimestamp();const t=document.getElementById("printBarcodeList");t.innerHTML="";const e=[...currentlyViewingBarcodes].reverse();for(let a=0;a<e.length;a+=30){const s=e.slice(a,a+30),n=document.createElement("div");n.className="print-column",s.forEach((t,e)=>{const s=document.createElement("div");s.textContent=`${a+e+1}. ${t}`,n.appendChild(s)}),t.appendChild(n)}window.print()}
        function downloadCsv(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No barcodes to download.",icon:"warning"});const t=[...currentlyViewingBarcodes].reverse();let e="No,Barcode\n";t.forEach((t,a)=>{e+=`${a+1},${t}\n`});const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`scanned_order_${currentlyViewingSessionId}.csv`,s.click()}
        
        // --- Unchanged Functions (except for minor text changes in alerts) ---
        function filterSessionsByDate(){const t=el.searchByDate.value;let e=allSessions;const a=getTodaySessionId();e=allSessions.filter(t=>t.id!==a),t&&(e=e.filter(e=>{const a=new Date(e.createdAt).toLocaleDateString("en-CA");return a===t})),el.savedSessionsSelect.innerHTML=`<option value="">Select a previous day</option>`,e.sort((t,e)=>e.createdAt-t.createdAt).forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,el.savedSessionsSelect.appendChild(e)})}
        function deleteSelectedSession(){const t=el.savedSessionsSelect.value;if(!t)return void Swal.fire({title:"Please select a previous day's session to delete.",icon:"warning"});Swal.fire({title:"Are you sure?",text:"This will permanently delete the selected day's session!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes, delete it"}).then(e=>{e.isConfirmed&&apiCall("deleteSession",{sessionId:t}).then(()=>{Swal.fire("Deleted!","The session has been deleted.","success"),allSessions=allSessions.filter(e=>e.id!==t),filterSessionsByDate()}).catch(()=>{Swal.fire("Error","Could not delete the session.","error")})})}
        function saveDataToGoogleSheet() { if (scannedBarcodes.length === 0) { return Swal.fire("No Data", "There are no barcodes for today to save.", "warning"); } el.saveToSheetBtn.disabled = true; el.saveBtnText.classList.add('hidden'); el.saveBtnSpinner.classList.remove('hidden'); el.sheetStatus.textContent = "Saving..."; el.sheetStatus.style.color = "#63b3ed"; const payload = { barcodes: [...scannedBarcodes].reverse(), sessionId: currentSessionId }; apiCall("saveData", payload) .then(() => { el.sheetStatus.textContent = "Data saved successfully!"; el.sheetStatus.style.color = "#48bb78"; Swal.fire("Success!", "Today's data has been saved to the daily sheet.", "success"); }) .catch(() => { el.sheetStatus.textContent = "Save failed. Check console."; el.sheetStatus.style.color = "#e53e3e"; Swal.fire("Error", "Failed to save data. Please check the console.", "error"); }) .finally(() => { el.saveToSheetBtn.disabled = false; el.saveBtnText.classList.remove('hidden'); el.saveBtnSpinner.classList.add('hidden'); setTimeout(() => { el.sheetStatus.textContent = "" }, 5000); }); }
        
        document.addEventListener("DOMContentLoaded", () => {
            el.loginButton.addEventListener('click', handleLogin);
            el.passcodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            el.passcodeInput.focus();
        });

    </script>
<audio id="successSound" src="play.mp3" preload="auto"></audio>
</body>
</html>
